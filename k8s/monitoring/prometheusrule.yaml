# Prometheus Alerting Rules for Webapp
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: webapp-alerts
  namespace: webapp
  labels:
    release: prometheus # Match Prometheus Operator selector
spec:
  groups:
    - name: webapp.rules
      rules:
        # Alert: Pod is down
        - alert: WebappPodDown
          expr: up{job="backend"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Webapp Backend pod is down"
            description: "Backend pod {{ $labels.pod }} has been down for more than 1 minute."

        # Alert: High CPU usage
        - alert: WebappHighCPU
          expr: |
            (
              sum(rate(container_cpu_usage_seconds_total{namespace="webapp"}[5m])) by (pod)
              /
              sum(kube_pod_container_resource_limits{namespace="webapp", resource="cpu"}) by (pod)
            ) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage detected"
            description: "Pod {{ $labels.pod }} CPU usage is above 80% for more than 5 minutes."

        # Alert: High Memory usage
        - alert: WebappHighMemory
          expr: |
            (
              sum(container_memory_working_set_bytes{namespace="webapp"}) by (pod)
              /
              sum(kube_pod_container_resource_limits{namespace="webapp", resource="memory"}) by (pod)
            ) > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High Memory usage detected"
            description: "Pod {{ $labels.pod }} memory usage is above 80% for more than 5 minutes."

        # Alert: Pod restart count
        - alert: WebappPodRestarting
          expr: increase(kube_pod_container_status_restarts_total{namespace="webapp"}[1h]) > 3
          for: 0m
          labels:
            severity: warning
          annotations:
            summary: "Pod restarting frequently"
            description: "Pod {{ $labels.pod }} has restarted more than 3 times in the last hour."

        # Alert: Deployment replicas mismatch
        - alert: WebappDeploymentReplicasMismatch
          expr: kube_deployment_spec_replicas{namespace="webapp"} != kube_deployment_status_replicas_available{namespace="webapp"}
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Deployment replicas mismatch"
            description: "Deployment {{ $labels.deployment }} has {{ $value }} available replicas, expected {{ $labels.spec_replicas }}."
